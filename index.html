<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SIMAP - Consulta CPF (Agentes P√∫blicos)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:end; }
    label { display:block; font-size:12px; margin-bottom:4px; }
    input { padding:8px; min-width:190px; }
    button { padding:10px 12px; cursor:pointer; }
    #log { white-space:pre-wrap; background:#f6f6f6; padding:10px; border:1px solid #ddd; margin-top:12px; }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th, td { border:1px solid #ddd; padding:8px; font-size:13px; vertical-align:top; }
    th { background:#fafafa; position:sticky; top:0; }
    .muted { color:#666; font-size:12px; margin-top:6px; }
  </style>
</head>
<body>
  <h2>SIMAP ‚Äî Consulta por CPF (Agentes P√∫blicos)</h2>

  <div class="row">
    <div>
      <label>C√≥digo do munic√≠pio</label>
      <input id="municipio" value="176" />
    </div>
    <div>
      <label>CPF (somente n√∫meros)</label>
      <input id="cpf" placeholder="00000000000" />
    </div>
    <div>
      <label>Ano inicial</label>
      <input id="anoIni" type="number" value="2020" />
    </div>
    <div>
      <label>Ano final</label>
      <input id="anoFim" type="number" value="2025" />
    </div>

    <button id="btnBuscar">Buscar</button>
    <button id="btnBaixarJson" disabled>Baixar JSON</button>
    <button id="btnBaixarCsv" disabled>Baixar CSV</button>
  </div>

  <div class="muted">
    A consulta chama <code>/api/agentes-publicos</code> no seu pr√≥prio dom√≠nio (proxy no Vercel) e espera <b>2s</b> entre anos.
  </div>

  <div id="log"></div>
  <div id="resultado"></div>

<script>
  const $ = (id) => document.getElementById(id);
  const logEl = $("log");
  const resEl = $("resultado");

  let ultimoResultado = [];
  let buscando = false;

  function log(msg) {
    console.log(msg);
    logEl.textContent += msg + "\n";
  }

  function digits(s) { return (s || "").replace(/\D+/g, ""); }
  function padMun(m) { return digits(m).padStart(3, "0"); }
  function exOrc(ano) { return String(ano) + "00"; }
  function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

  async function getJSON(url) {
    const r = await fetch(url, { method: "GET" });
    const text = await r.text();
    if (!r.ok) throw new Error(`HTTP ${r.status}: ${text.slice(0, 250)}`);
    try { return JSON.parse(text); }
    catch { throw new Error("Resposta n√£o √© JSON"); }
  }

  function toCSV(rows) {
    const cols = Array.from(new Set(rows.flatMap(r => Object.keys(r))));
    const esc = v => {
      const s = (v == null) ? "" : String(v);
      const needs = /[",\n;]/.test(s);
      const safe = s.replaceAll('"', '""');
      return needs ? `"${safe}"` : safe;
    };
    return [cols.join(";"), ...rows.map(r => cols.map(c => esc(r[c])).join(";"))].join("\n");
  }

  function download(name, text, mime) {
    const blob = new Blob([text], { type: mime || "text/plain;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = name;
    a.click();
    setTimeout(() => URL.revokeObjectURL(a.href), 1000);
  }

  function render(rows) {
    if (!rows.length) {
      resEl.innerHTML = "<p><b>Nenhum registro encontrado.</b></p>";
      return;
    }

    const cols = Array.from(new Set(rows.flatMap(r => Object.keys(r))));

    const thead = `<thead><tr>${cols.map(c => `<th>${c}</th>`).join("")}</tr></thead>`;
    const tbody = `<tbody>${
      rows.map(r => `<tr>${cols.map(c => `<td>${r[c] ?? ""}</td>`).join("")}</tr>`).join("")
    }</tbody>`;

    resEl.innerHTML = `
      <p><b>Total:</b> ${rows.length} registro(s)</p>
      <div style="overflow:auto; max-height:70vh;">
        <table>${thead}${tbody}</table>
      </div>
    `;
  }

  async function buscar() {
    if (buscando) return;
    buscando = true;

    logEl.textContent = "";
    resEl.innerHTML = "";
    ultimoResultado = [];
    $("btnBaixarJson").disabled = true;
    $("btnBaixarCsv").disabled = true;
    $("btnBuscar").disabled = true;

    try {
      const municipio = padMun($("municipio").value);
      const cpf = digits($("cpf").value);
      const anoIni = parseInt($("anoIni").value, 10);
      const anoFim = parseInt($("anoFim").value, 10);

      if (cpf.length !== 11) {
        log("‚ö†Ô∏è CPF inv√°lido (precisa ter 11 d√≠gitos).");
        return;
      }
      if (!anoIni || !anoFim || anoIni > anoFim) {
        log("‚ö†Ô∏è Intervalo de anos inv√°lido.");
        return;
      }

      log(`Munic√≠pio: ${municipio}`);
      log(`CPF: ${cpf}`);
      log(`Intervalo: ${anoIni} ‚Üí ${anoFim}\n`);

      const out = [];

      for (let ano = anoIni; ano <= anoFim; ano++) {
        const exercicio_orcamento = exOrc(ano);

        const url =
          `/api/agentes-publicos?codigo_municipio=${encodeURIComponent(municipio)}` +
          `&exercicio_orcamento=${encodeURIComponent(exercicio_orcamento)}` +
          `&cpf_servidor=${encodeURIComponent(cpf)}`;

        log(`üîé Consultando ${ano} (${exercicio_orcamento})...`);

        try {
          const data = await getJSON(url);

          const rows = Array.isArray(data)
            ? data
            : (Array.isArray(data?.data) ? data.data : (Array.isArray(data?.result) ? data.result : []));

          log(`  ‚úÖ ${rows.length} registro(s)`);

          for (const r of rows) {
            out.push({ ano, exercicio_orcamento, codigo_municipio: municipio, cpf_servidor: cpf, ...r });
          }
        } catch (e) {
          log(`  ‚ùå Erro: ${e.message}`);
        }

        // ‚úÖ espera 2s entre uma requisi√ß√£o e outra
        if (ano < anoFim) {
          log("  ‚è≥ Aguardando 2s antes da pr√≥xima consulta...");
          await sleep(2000);
        }
      }

      ultimoResultado = out;

      log(`\n‚úÖ Conclu√≠do. Total acumulado: ${out.length} registro(s).`);
      render(out);

      $("btnBaixarJson").disabled = out.length === 0;
      $("btnBaixarCsv").disabled = out.length === 0;

    } finally {
      $("btnBuscar").disabled = false;
      buscando = false;
    }
  }

  $("btnBuscar").addEventListener("click", buscar);

  $("btnBaixarJson").addEventListener("click", () => {
    download(
      `agentes_publicos_${digits($("cpf").value)}_${$("anoIni").value}-${$("anoFim").value}_mun${digits($("municipio").value)}.json`,
      JSON.stringify(ultimoResultado, null, 2),
      "application/json;charset=utf-8"
    );
  });

  $("btnBaixarCsv").addEventListener("click", () => {
    download(
      `agentes_publicos_${digits($("cpf").value)}_${$("anoIni").value}-${$("anoFim").value}_mun${digits($("municipio").value)}.csv`,
      toCSV(ultimoResultado),
      "text/csv;charset=utf-8"
    );
  });
</script>
</body>
</html>
