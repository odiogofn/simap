<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SIMAP ‚Äî Itens Remunerat√≥rios</title>
  <style>
    :root{
      --bg:#f7f8fc;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --soft:#f1f5f9;
      --brand:#2563eb;
      --warn:#ef4444;
      --shadow: 0 10px 30px rgba(2,6,23,.08);
      --shadow2: 0 6px 16px rgba(2,6,23,.08);
      --radius: 16px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(900px 500px at 20% 0%, rgba(37,99,235,.10), transparent 60%),
                  radial-gradient(700px 400px at 90% 10%, rgba(34,197,94,.10), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{ max-width:1200px; margin: 22px auto 36px; padding: 0 16px; }

    header{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      padding: 14px 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.75);
      backdrop-filter: blur(10px);
      border-radius: calc(var(--radius) + 6px);
      box-shadow: var(--shadow2);
    }
    .title{ display:flex; flex-direction:column; gap:2px; }
    h1{ margin:0; font-size:18px; letter-spacing: .2px; }
    .subtitle{ margin:0; color:var(--muted); font-size:12px; line-height: 1.35; }

    .controls{
      display:grid;
      grid-template-columns: 1.2fr 1.2fr auto auto;
      gap:10px;
      align-items:end;
      width: 100%;
      max-width: 860px;
    }
    .field label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:0 0 6px;
    }
    .input, select{
      width:100%;
      border:1px solid var(--line);
      background: #fff;
      color:var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      font-size:14px;
      outline:none;
      box-shadow: 0 1px 0 rgba(2,6,23,.02);
    }
    .input:focus, select:focus{
      border-color: rgba(37,99,235,.55);
      box-shadow: 0 0 0 4px rgba(37,99,235,.12);
    }

    .btn{
      border:0;
      border-radius: 12px;
      padding: 11px 14px;
      font-weight: 900;
      cursor:pointer;
      transition: transform .06s ease, filter .15s ease, background .15s ease;
      box-shadow: var(--shadow2);
      white-space: nowrap;
    }
    .btn:active{ transform: translateY(1px); }
    .btnPrimary{
      background: linear-gradient(135deg, var(--brand), #4f46e5);
      color:white;
    }
    .btnPrimary:hover{ filter: brightness(1.03); }
    .btnGhost{
      background:#fff;
      border:1px solid var(--line);
      color: var(--text);
    }
    .btnGhost:hover{ background: var(--soft); }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; box-shadow:none; }

    .hint{ margin: 12px 4px 0; color: var(--muted); font-size: 12px; }

    .log{
      margin-top:12px;
      border:1px solid var(--line);
      background: #fff;
      border-radius: var(--radius);
      padding: 10px 12px;
      box-shadow: var(--shadow2);
    }
    .log .line{ font-size:13px; line-height:1.4; white-space:pre-wrap; }
    .ok{ color: #16a34a; }
    .bad{ color: var(--warn); }

    .tabs{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 14px; }
    .tab{
      display:flex; align-items:center; gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      font-weight: 950;
      color: var(--text);
      box-shadow: var(--shadow2);
      user-select:none;
    }
    .tab.active{
      border-color: rgba(37,99,235,.35);
      box-shadow: 0 0 0 4px rgba(37,99,235,.12), var(--shadow2);
    }
    .dot{ width:8px; height:8px; border-radius:999px; background: rgba(100,116,139,.5); }
    .tab.active .dot{ background: var(--brand); }

    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-top: 14px; }

    .card{
      border:1px solid var(--line);
      background: var(--card);
      border-radius: var(--radius);
      padding: 12px 12px;
      box-shadow: var(--shadow);
    }
    .cardHeader{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-bottom: 10px;
    }
    .cardTitle{
      display:flex; align-items:center; gap:10px;
      font-weight: 1000; font-size: 14px; letter-spacing:.2px; margin:0;
    }
    .pill{
      font-size:12px; padding: 4px 10px; border-radius: 999px;
      background: var(--soft); border:1px solid var(--line);
      color: var(--muted); font-weight: 950;
    }
    .meta{
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 12px; color: var(--muted);
    }

    .tableWrap{
      max-height: 52vh; overflow:auto;
      border-radius: 12px; border: 1px solid var(--line);
    }
    table{ width:100%; border-collapse: collapse; background:#fff; }
    th, td{ border-bottom:1px solid var(--line); padding: 10px 10px; font-size: 13px; vertical-align: top; }
    th{
      position: sticky; top: 0;
      background: #fbfbfe; z-index: 1;
      text-align: left; font-size: 12px;
      color: var(--muted); letter-spacing: .3px; text-transform: uppercase;
    }
    tr:hover td{ background: rgba(37,99,235,.04); }

    .section{ margin-top:14px; }
    .hidden{ display:none; }

    @media (max-width: 980px){
      header{ flex-direction: column; align-items: stretch; }
      .controls{ grid-template-columns: 1fr 1fr; max-width:none; }
      .grid{ grid-template-columns: 1fr; }
    }
    @media (max-width: 560px){
      .controls{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>SIMAP ‚Äî Itens Remunerat√≥rios</h1>
        <p class="subtitle">
          Carrega via proxy (Vercel), mostra faltantes (1000‚Äì1999 / 2000‚Äì2999), vazios e pesquisa ‚ÄúINSS‚Äù em tempo real.
        </p>
      </div>

      <div class="controls">
        <div class="field">
          <label>Buscar munic√≠pio</label>
          <input id="municipioSearch" class="input" placeholder="Digite: fortaleza, sobral, juazeiro..." />
        </div>

        <div class="field">
          <label>Munic√≠pio</label>
          <select id="municipioSelect"></select>
        </div>

        <button id="btnCarregar" class="btn btnPrimary">Carregar</button>
        <button id="btnBaixarRelatorio" class="btn btnGhost" disabled>Baixar TXT</button>
      </div>
    </header>

    <div class="hint">
      Regras: <b>1000‚Äì1999</b> Prefeitura ¬∑ <b>2000‚Äì2999</b> C√¢mara ¬∑ Campo: <code>codigo_item</code>.
    </div>

    <div id="log" class="log"></div>

    <div class="tabs">
      <div class="tab active" id="tabFaltantesBtn"><span class="dot"></span>Faltantes</div>
      <div class="tab" id="tabPesquisarBtn"><span class="dot"></span>Pesquisar</div>
    </div>

    <div id="tabFaltantes">
      <div class="grid">
        <div class="card">
          <div class="cardHeader">
            <div class="cardTitle">Prefeitura <span class="pill">1000‚Äì1999</span></div>
            <div id="prefResumo" class="meta"></div>
          </div>
          <div class="tableWrap">
            <table id="prefTable"></table>
          </div>
        </div>

        <div class="card">
          <div class="cardHeader">
            <div class="cardTitle">C√¢mara <span class="pill">2000‚Äì2999</span></div>
            <div id="camResumo" class="meta"></div>
          </div>
          <div class="tableWrap">
            <table id="camTable"></table>
          </div>
        </div>
      </div>

      <div class="card section">
        <div class="cardHeader">
          <div class="cardTitle">Vazios / inv√°lidos <span class="pill">sempre</span></div>
          <div id="vazioResumo" class="meta"></div>
        </div>
        <div class="tableWrap" style="max-height: 44vh;">
          <table id="vazioTable"></table>
        </div>
      </div>
    </div>

    <div id="tabPesquisar" class="hidden">
      <div class="card section">
        <div class="cardHeader">
          <div class="cardTitle">Busca em tempo real <span class="pill">qualquer campo</span></div>
          <div id="searchResumo" class="meta"></div>
        </div>

        <div class="controls" style="max-width:none; grid-template-columns: 1.2fr .6fr auto;">
          <div class="field">
            <label>Termo (ex: INSS)</label>
            <input id="searchInput" class="input" placeholder="Digite para filtrar..." />
          </div>
          <div class="field">
            <label>Limite</label>
            <input id="searchLimit" class="input" type="number" value="300" />
          </div>
          <button id="btnLimparBusca" class="btn btnGhost">Limpar</button>
        </div>

        <div class="tableWrap" style="max-height: 70vh; margin-top: 10px;">
          <table id="searchTable"></table>
        </div>
      </div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  const logEl = $("log");
  const prefResumoEl = $("prefResumo");
  const camResumoEl  = $("camResumo");
  const vazioResumoEl = $("vazioResumo");

  const prefTableEl = $("prefTable");
  const camTableEl  = $("camTable");
  const vazioTableEl = $("vazioTable");

  const tabFaltantesBtn = $("tabFaltantesBtn");
  const tabPesquisarBtn = $("tabPesquisarBtn");
  const tabFaltantes = $("tabFaltantes");
  const tabPesquisar = $("tabPesquisar");

  const searchInput = $("searchInput");
  const searchLimit = $("searchLimit");
  const btnLimparBusca = $("btnLimparBusca");
  const searchResumo = $("searchResumo");
  const searchTable = $("searchTable");

  const municipioSearch = $("municipioSearch");
  const municipioSelect = $("municipioSelect");

  let rowsCache = [];
  let rowsSearchIndex = [];
  let ultimoRelatorio = null;

  const MUNICIPIOS = [
    ["ABAIARA","002"],["ACARAPE","003"],["ACARAU","004"],["ACOPIARA","005"],["AIUABA","006"],
    ["ALCANTARAS","007"],["ALTANEIRA","008"],["ALTO SANTO","009"],["AMONTADA","010"],["ANTONINA DO NORTE","011"],
    ["APUIARES","012"],["AQUIRAZ","013"],["ARACATI","014"],["ARACOIABA","015"],["ARARIPE","016"],
    ["ARATUBA","017"],["ARNEIROZ","018"],["ASSARE","019"],["AURORA","020"],["BAIXIO","021"],
    ["BANABUIU","022"],["BARBALHA","023"],["BARREIRA","024"],["BARRO","025"],["BARROQUINHA","026"],
    ["BATURITE","027"],["BEBERIBE","028"],["BELA CRUZ","029"],["BOA VIAGEM","030"],["BREJO SANTO","031"],
    ["CAMOCIM","032"],["CAMPOS SALES","033"],["CANINDE","034"],["CAPISTRANO","035"],["CARIDADE","036"],
    ["CARIRE","037"],["CARIRIACU","038"],["CARIUS","039"],["CARNAUBAL","040"],["CASCAVEL","041"],
    ["CATARINA","042"],["CAUCAIA","043"],["CEDRO","044"],["CHAVAL","045"],["CHOROZINHO","046"],
    ["COREAU","047"],["CRATEUS","048"],["CRATO","049"],["CROATA","050"],["CRUZ","051"],
    ["DEPUTADO IRAPUAN PINHEIRO","052"],["ERERE","053"],["EUSEBIO","054"],["FARIAS BRITO","055"],["FORQUILHA","056"],
    ["FORTALEZA","057"],["FRECHEIRINHA","058"],["GENERAL SAMPAIO","059"],["GRACA","060"],["GRANJA","061"],
    ["GRANJEIRO","062"],["GROAIRAS","063"],["GUAIUBA","064"],["GUARACIABA DO NORTE","065"],["GUARAMIRANGA","066"],
    ["HIDROLANDIA","067"],["HORIZONTE","068"],["IBARETAMA","069"],["IBIAPINA","070"],["IBICUITINGA","071"],
    ["ICAPUI","072"],["ICO","073"],["IGUATU","074"],["INDEPENDENCIA","075"],["IPAPORANGA","076"],
    ["IPAUMIRIM","077"],["IPU","078"],["IPUEIRAS","079"],["IRACEMA","080"],["IRAUCUBA","081"],
    ["ITAICABA","082"],["ITAPAJE","083"],["ITAPIPOCA","084"],["ITAPIUNA","085"],["ITAREMA","086"],
    ["ITATIRA","087"],["JAGUARETAMA","088"],["JAGUARIBARA","089"],["JAGUARIBE","090"],["JAGUARUANA","091"],
    ["JARDIM","092"],["JATI","093"],["JUAZEIRO DO NORTE","094"],["JUCAS","095"],["LAVRAS DA MANGABEIRA","096"],
    ["LIMOEIRO DO NORTE","097"],["MADALENA","098"],["MARACANAU","099"],["MARANGUAPE","100"],["MARCO","101"],
    ["MARTINOPOLE","102"],["MASSAPE","103"],["MAURITI","104"],["MERUOCA","105"],["MILAGRES","106"],
    ["MILHA","107"],["MIRAIMA","108"],["MISSAO VELHA","109"],["MUCAMBO","110"],["MOMBACA","111"],
    ["MONSENHOR TABOSA","112"],["MORADA NOVA","113"],["MORAUJO","114"],["MORRINHOS","115"],["MULUNGU","116"],
    ["NOVA OLINDA","117"],["NOVA RUSSAS","118"],["NOVO ORIENTE","119"],["OCARA","120"],["OROS","121"],
    ["PACAJUS","122"],["PACATUBA","123"],["PACOTI","124"],["PACUJA","125"],["PALHANO","126"],
    ["PALMACIA","127"],["PARACURU","128"],["PARAIPABA","129"],["PARAMBU","130"],["PARAMOTI","131"],
    ["PEDRA BRANCA","132"],["PENAFORTE","133"],["PENTECOSTE","134"],["PEREIRO","135"],["PINDORETAMA","136"],
    ["PIQUET CARNEIRO","137"],["PIRES FERREIRA","138"],["PORANGA","139"],["PORTEIRAS","140"],["POTENGI","141"],
    ["POTIRETAMA","142"],["QUITERIANOPOLIS","143"],["QUIXADA","144"],["QUIXELO","145"],["QUIXERAMOBIM","146"],
    ["QUIXERE","147"],["REDENCAO","148"],["RERIUTABA","149"],["RUSSAS","150"],["SABOEIRO","151"],
    ["SALITRE","152"],["SANTANA DO ACARAU","153"],["SANTANA DO CARIRI","154"],["SANTA QUITERIA","155"],["SAO BENEDITO","156"],
    ["SAO GONCALO DO AMARANTE","157"],["SAO JOAO DO JAGUARIBE","158"],["SAO LUIS DO CURU","159"],["SENADOR POMPEU","160"],["SENADOR SA","161"],
    ["SOBRAL","162"],["SOLONOPOLE","163"],["TABULEIRO DO NORTE","164"],["TAMBORIL","165"],["TARRAFAS","166"],
    ["TAUA","167"],["TEJUCUOCA","168"],["TIANGUA","169"],["TRAIRI","170"],["TURURU","171"],
    ["UBAJARA","172"],["UMARI","173"],["UMIRIM","174"],["URUBURETAMA","175"],["URUOCA","176"],
    ["VARJOTA","177"],["VARZEA ALEGRE","178"],["VICOSA DO CEARA","179"],["ARARENDA","180"],["CATUNDA","181"],
    ["CHORO","182"],["FORTIM","183"],["ITAITINGA","184"],["JIJOCA DE JERICOACOARA","185"]
  ];

  function addLog(msg, kind="") {
    const d = document.createElement("div");
    d.className = "line" + (kind ? " " + kind : "");
    d.textContent = msg;
    logEl.appendChild(d);
    console.log(msg);
  }
  function resetLog(){ logEl.innerHTML = ""; }

  function normalizeText(s) {
    return (s || "").toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
  }
  function renderMunicipios(list, keepValue) {
    municipioSelect.innerHTML = "";
    for (const [nome, cod] of list) {
      const opt = document.createElement("option");
      opt.value = cod;
      opt.textContent = `${nome} (${cod})`;
      municipioSelect.appendChild(opt);
    }
    if (keepValue && list.some(([,c]) => c === keepValue)) municipioSelect.value = keepValue;
    else if (list.length) municipioSelect.value = list[0][1];
  }
  function filterMunicipios() {
    const q = normalizeText(municipioSearch.value.trim());
    const cur = municipioSelect.value;
    if (!q) return renderMunicipios(MUNICIPIOS, cur);
    const filtered = MUNICIPIOS.filter(([nome, cod]) => normalizeText(nome).includes(q) || cod.includes(q));
    renderMunicipios(filtered, cur);
  }
  let munTimer = null;
  municipioSearch.addEventListener("input", () => { clearTimeout(munTimer); munTimer = setTimeout(filterMunicipios, 90); });
  municipioSearch.addEventListener("keydown", (e) => { if (e.key === "Enter") municipioSelect.focus(); });

  function digitsOnly(s){ return (s ?? "").toString().replace(/\D+/g, ""); }
  function normalizeApi(payload){
    if (payload?.rsp && Array.isArray(payload.rsp._content)) return payload.rsp._content;
    if (Array.isArray(payload)) return payload;
    return [];
  }
  function expected(from, to){ const out=[]; for(let i=from;i<=to;i++) out.push(i); return out; }

  function analyze(rows, municipio) {
    const field = "codigo_item";
    const prefFrom=1000, prefTo=1999;
    const camFrom=2000, camTo=2999;

    const presentPref = new Set();
    const presentCam  = new Set();
    const vazios = [];

    for (const r of rows) {
      const raw = r?.[field];
      const d = digitsOnly(raw);

      if (!d) { vazios.push({ motivo: "vazio", codigo_item: raw ?? "", ...r }); continue; }

      const n = Number(d);
      if (!Number.isFinite(n)) { vazios.push({ motivo: "nao-numerico", codigo_item: raw ?? "", ...r }); continue; }
      if (n === 0) { vazios.push({ motivo: "zero", codigo_item: raw ?? "", ...r }); continue; }

      if (n >= prefFrom && n <= prefTo) presentPref.add(n);
      else if (n >= camFrom && n <= camTo) presentCam.add(n);
    }

    return {
      municipio,
      field,
      prefMissing: expected(prefFrom, prefTo).filter(n => !presentPref.has(n)),
      camMissing: expected(camFrom, camTo).filter(n => !presentCam.has(n)),
      vazios,
      presentPrefCount: presentPref.size,
      presentCamCount: presentCam.size
    };
  }

  function renderMissing(tableEl, missing) {
    tableEl.innerHTML = `
      <thead><tr><th>codigo_faltando</th></tr></thead>
      <tbody>${missing.map(n => `<tr><td>${n}</td></tr>`).join("")}</tbody>
    `;
  }

  function renderVazios(tableEl, vazios, maxRows=300) {
    if (!vazios.length) {
      tableEl.innerHTML = `<thead><tr><th>status</th></tr></thead><tbody><tr><td>Sem vazios/ inv√°lidos</td></tr></tbody>`;
      return;
    }
    const cols = ["motivo","codigo_municipio","codigo_item","tipo_item","descricao_item","data_publicacao","st_extinto_ir","data_referencia"];
    tableEl.innerHTML = `
      <thead><tr>${cols.map(c => `<th>${c}</th>`).join("")}</tr></thead>
      <tbody>
        ${vazios.slice(0, maxRows).map(r => `
          <tr>${cols.map(c => `<td>${r?.[c] ?? ""}</td>`).join("")}</tr>
        `).join("")}
      </tbody>
    `;
  }

  function buildReportTxt(r) {
    const lines = [];
    lines.push(`MUNICIPIO: ${r.municipio}`);
    lines.push(`CAMPO_CODIGO: ${r.field}`);
    lines.push("");
    lines.push("PREFEITURA (1000-1999)");
    lines.push(`Presentes: ${r.presentPrefCount}`);
    lines.push(`Faltando: ${r.prefMissing.length}`);
    lines.push(r.prefMissing.join(", "));
    lines.push("");
    lines.push("CAMARA (2000-2999)");
    lines.push(`Presentes: ${r.presentCamCount}`);
    lines.push(`Faltando: ${r.camMissing.length}`);
    lines.push(r.camMissing.join(", "));
    lines.push("");
    lines.push("VAZIOS/INVALIDOS");
    lines.push(`Quantidade: ${r.vazios.length}`);
    return lines.join("\n");
  }

  function downloadText(filename, text) {
    const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    setTimeout(() => URL.revokeObjectURL(a.href), 1000);
  }

  function setTab(which) {
    const isF = which === "faltantes";
    tabFaltantes.classList.toggle("hidden", !isF);
    tabPesquisar.classList.toggle("hidden", isF);
    tabFaltantesBtn.classList.toggle("active", isF);
    tabPesquisarBtn.classList.toggle("active", !isF);
  }
  tabFaltantesBtn.addEventListener("click", () => setTab("faltantes"));
  tabPesquisarBtn.addEventListener("click", () => setTab("pesquisar"));

  function buildSearchIndex(rows){ rowsSearchIndex = rows.map(row => ({ row, haystack: JSON.stringify(row).toLowerCase() })); }
  function renderSearchRows(rows) {
    if (!rows.length) {
      searchTable.innerHTML = `<thead><tr><th>status</th></tr></thead><tbody><tr><td>Nenhum registro encontrado</td></tr></tbody>`;
      return;
    }
    const cols = ["codigo_municipio","codigo_item","tipo_item","descricao_item","tipo_classificacao","st_extinto_ir","data_publicacao","data_referencia"];
    searchTable.innerHTML = `
      <thead><tr>${cols.map(c => `<th>${c}</th>`).join("")}</tr></thead>
      <tbody>${rows.map(r => `<tr>${cols.map(c => `<td>${r?.[c] ?? ""}</td>`).join("")}</tr>`).join("")}</tbody>
    `;
  }
  function doSearchNow() {
    const q = (searchInput.value || "").trim().toLowerCase();
    const limit = Math.max(1, Math.min(5000, parseInt(searchLimit.value || "300", 10)));

    if (!rowsCache.length) { searchResumo.textContent = "Carregue os dados primeiro."; searchTable.innerHTML = ""; return; }
    if (!q) { searchResumo.textContent = `Total carregado: ${rowsCache.length}. Digite um termo.`; searchTable.innerHTML = ""; return; }

    const hits = [];
    for (const item of rowsSearchIndex) {
      if (item.haystack.includes(q)) { hits.push(item.row); if (hits.length >= limit) break; }
    }
    searchResumo.textContent = `Termo: "${q}" ¬∑ ${hits.length} resultado(s) (limite ${limit})`;
    renderSearchRows(hits);
  }
  let searchTimer = null;
  function scheduleSearch(){ clearTimeout(searchTimer); searchTimer = setTimeout(doSearchNow, 120); }
  searchInput.addEventListener("input", scheduleSearch);
  searchLimit.addEventListener("input", scheduleSearch);
  btnLimparBusca.addEventListener("click", () => { searchInput.value=""; doSearchNow(); });

  async function carregar() {
    resetLog();

    prefResumoEl.textContent = "";
    camResumoEl.textContent  = "";
    vazioResumoEl.textContent = "";
    prefTableEl.innerHTML = "";
    camTableEl.innerHTML  = "";
    vazioTableEl.innerHTML = "";
    $("btnBaixarRelatorio").disabled = true;
    ultimoRelatorio = null;

    const municipio = municipioSelect.value;
    if (!municipio) { addLog("‚ö†Ô∏è Selecione um munic√≠pio.", "bad"); return; }

    const alvo = "https://api.tce.ce.gov.br/index.php/sim/1_0/itens_remuneratorios.json?codigo_municipio=" + encodeURIComponent(municipio);
    const url  = "/api/proxy?url=" + encodeURIComponent(alvo);

    addLog(`üîé Consultando via proxy... Munic√≠pio ${municipio}`);

    try {
      const resp = await fetch(url);
      const payload = await resp.json();

      if (!resp.ok) {
        addLog("‚ùå Proxy retornou erro.", "bad");
        addLog(JSON.stringify(payload, null, 2).slice(0, 1600), "bad");
        return;
      }

      const rows = normalizeApi(payload);
      rowsCache = rows;
      buildSearchIndex(rows);

      addLog(`‚úÖ Registros recebidos: ${rows.length}`, "ok");

      const result = analyze(rows, municipio);
      ultimoRelatorio = result;

      prefResumoEl.textContent = `Presentes: ${result.presentPrefCount} ¬∑ Faltando: ${result.prefMissing.length}`;
      camResumoEl.textContent  = `Presentes: ${result.presentCamCount} ¬∑ Faltando: ${result.camMissing.length}`;
      vazioResumoEl.textContent = `Vazios/Inv√°lidos: ${result.vazios.length}`;

      renderMissing(prefTableEl, result.prefMissing);
      renderMissing(camTableEl, result.camMissing);
      renderVazios(vazioTableEl, result.vazios);

      $("btnBaixarRelatorio").disabled = false;
      addLog("‚úÖ Pronto! V√° na aba Pesquisar e digite INSS.", "ok");

      doSearchNow();
    } catch (e) {
      addLog(`‚ùå Erro: ${String(e?.message || e)}`, "bad");
    }
  }

  $("btnCarregar").addEventListener("click", carregar);
  $("btnBaixarRelatorio").addEventListener("click", () => {
    if (!ultimoRelatorio) return;
    downloadText(`faltantes_itens_remuneratorios_mun${ultimoRelatorio.municipio}.txt`, buildReportTxt(ultimoRelatorio));
  });

  renderMunicipios(MUNICIPIOS, "057");
  municipioSelect.value = "057";
</script>
</body>
</html>
