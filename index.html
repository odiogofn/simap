<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SIMAP Offline - Baixar e Pesquisar CPF</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:end; }
    label { display:block; font-size:12px; margin-bottom:4px; }
    input { padding:8px; min-width:190px; }
    button { padding:10px 12px; cursor:pointer; }
    #log { white-space:pre-wrap; background:#f6f6f6; padding:10px; border:1px solid #ddd; margin-top:12px; }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th, td { border:1px solid #ddd; padding:8px; font-size:13px; vertical-align:top; }
    th { background:#fafafa; position:sticky; top:0; }
  </style>
</head>
<body>
  <h2>SIMAP Offline — Baixar dados e pesquisar CPF</h2>

  <div class="row">
    <div>
      <label>Município</label>
      <input id="municipio" value="176" />
    </div>
    <div>
      <label>Ano inicial</label>
      <input id="anoIni" type="number" value="2020" />
    </div>
    <div>
      <label>Ano final</label>
      <input id="anoFim" type="number" value="2025" />
    </div>
    <button id="btnBaixar">Baixar e salvar no navegador</button>
    <button id="btnLimpar">Limpar cache</button>
  </div>

  <hr />

  <div class="row">
    <div>
      <label>CPF para pesquisar</label>
      <input id="cpf" placeholder="00000000000" />
    </div>
    <button id="btnPesquisar">Pesquisar no cache</button>
  </div>

  <div id="log"></div>
  <div id="resultado"></div>

<script>
  const $ = (id) => document.getElementById(id);
  const logEl = $("log");
  const resEl = $("resultado");

  const BASE = "https://api.tce.ce.gov.br/index.php/sim/1_0/agentes_publicos.json";

  function log(msg){ console.log(msg); logEl.textContent += msg + "\n"; }
  function digits(s){ return (s || "").replace(/\D+/g, ""); }
  function padMun(m){ return digits(m).padStart(3, "0"); }
  function exOrc(ano){ return String(ano) + "00"; }
  function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

  // ---------- IndexedDB ----------
  const DB_NAME = "simap_cache";
  const DB_VERSION = 1;
  const STORE = "agentes_publicos"; // key: municipio|exercicio

  function openDB() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, DB_VERSION);
      req.onupgradeneeded = () => {
        const db = req.result;
        if (!db.objectStoreNames.contains(STORE)) {
          db.createObjectStore(STORE, { keyPath: "key" });
        }
      };
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }

  async function idbPut(key, payload) {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE, "readwrite");
      tx.objectStore(STORE).put({ key, payload, savedAt: Date.now() });
      tx.oncomplete = () => resolve();
      tx.onerror = () => reject(tx.error);
    });
  }

  async function idbGet(key) {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE, "readonly");
      const req = tx.objectStore(STORE).get(key);
      req.onsuccess = () => resolve(req.result || null);
      req.onerror = () => reject(req.error);
    });
